<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script src="assets/data/decade_dominance_data.js"></script>

<div id="decade-viz-wrapper">
  <style>
    /* Scoped wrapper to prevent global site conflicts */
    #decade-viz-wrapper {
      font-family: inherit; /* Use website font */
      width: 100%;
      padding: 0;
      background: transparent;
      box-sizing: border-box;
    }

    #decade-viz-wrapper * {
      box-sizing: border-box;
    }

    #decade-viz-wrapper #charts-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    #decade-viz-wrapper .decade-card {
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      color: #1b202b;
    }

    #decade-viz-wrapper .decade-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1b202b;
      text-align: center;
      margin-bottom: 5px;
    }

    #decade-viz-wrapper .decade-subtitle {
      font-size: 0.85rem;
      color: #1b202b; /* Slightly lighter text usually, but using theme text col */
      opacity: 0.7;
      text-align: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
    }

    #decade-viz-wrapper .chart-wrapper {
      display: flex;
      flex-direction: row;
    }

    #decade-viz-wrapper .chart-container {
      flex: 1;
      height: 300px; /* Slightly compacted */
    }

    #decade-viz-wrapper .legend-section {
      width: 160px;
      padding: 10px 0 10px 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    #decade-viz-wrapper .legend-title {
      font-weight: bold;
      font-size: 0.75rem;
      color: #1b202b;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #decade-viz-wrapper .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: #1b202b;
    }

    #decade-viz-wrapper .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    #decade-viz-wrapper .legend-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #decade-viz-wrapper .non-dominant-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #e2e8f0;
    }

    #decade-viz-wrapper .non-dominant-title {
      font-size: 0.7rem;
      color: #1b202b;
      opacity: 0.6;
      font-weight: bold;
      margin-bottom: 6px;
    }

    #decade-viz-wrapper .non-dominant-item {
      display: flex;
      align-items: center;
      font-size: 0.75rem;
      margin-bottom: 4px;
      color: #1b202b;
      opacity: 0.8;
    }

    /* Mobile Stack */
    @media (max-width: 768px) {
      #decade-viz-wrapper #charts-container {
        grid-template-columns: 1fr;
      }
      #decade-viz-wrapper .chart-wrapper {
        flex-direction: column;
      }
      #decade-viz-wrapper .legend-section {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
        border-top: 1px solid #e2e8f0;
        margin-top: 10px;
      }
    }
  </style>

  <div id="charts-container"></div>
</div>

<script>
  // Use a unique prefix 'dec_' to avoid conflicts
  let dec_decadeData = typeof decade_data !== "undefined" ? decade_data : null;
  const dec_charts = {};

  // Color palette for dynasties
  const dec_dynastyColors = {
    0: "#5470c6",
    1: "#91cc75",
    2: "#fac858",
    3: "#ee6666",
    4: "#73c0de",
    5: "#3ba272",
    6: "#fc8452",
    7: "#9a60b4",
    8: "#ea7ccc",
    9: "#d4ec59",
    10: "#c23531",
    11: "#2f4554",
    12: "#61a0a8",
    13: "#d48265",
    14: "#91c7ae",
  };

  // Helper: Truncate Sector
  function dec_truncateSector(sector, maxLen = 15) {
    if (!sector) return "Unknown";
    if (sector.length > maxLen) {
      return sector.substring(0, maxLen - 2) + "..";
    }
    return sector;
  }

  // Main Chart Creation Function
  function dec_createAllCharts() {
    if (!dec_decadeData) {
      console.error("Data not loaded yet.");
      return;
    }

    const container = document.querySelector(
      "#decade-viz-wrapper #charts-container"
    );
    if (!container) return;

    // Sort decades chronologically by start year
    const decades = Object.keys(dec_decadeData).sort((a, b) => {
      return dec_decadeData[a].start_year - dec_decadeData[b].start_year;
    });

    decades.forEach((decade) => {
      const data = dec_decadeData[decade];

      // Create card
      const card = document.createElement("div");
      card.className = "decade-card";
      card.id = `card-${decade}`;

      // Separate dominant and non-dominant dynasties
      const dominantDynasties = data.dynasties.filter(
        (d) => d.years_dominant > 0
      );
      const nonDominantDynasties = data.dynasties.filter(
        (d) => d.years_dominant === 0
      );

      // Build dominant legend HTML
      let dominantLegendHTML = dominantDynasties
        .map(
          (d) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${
                          dec_dynastyColors[d.dynasty_id] || "#ccc"
                        };"></div>
                        <div class="legend-text" title="D${d.dynasty_id} - ${
            d.primary_sector
          }">
                            D${d.dynasty_id} - <strong>${
            d.dominance_percentage
          }%</strong>
                        </div>
                    </div>
                `
        )
        .join("");

      // Build non-dominant legend HTML
      let nonDominantLegendHTML = "";
      if (nonDominantDynasties.length > 0) {
        const items = nonDominantDynasties
          .map(
            (d) => `
                        <div class="non-dominant-item">
                            <div class="legend-color" style="background: ${
                              dec_dynastyColors[d.dynasty_id] || "#ccc"
                            }; opacity: 0.6;"></div>
                            <div class="legend-text">D${d.dynasty_id}</div>
                        </div>
                    `
          )
          .join("");
        nonDominantLegendHTML = `
                        <div class="non-dominant-section">
                            <div class="non-dominant-title">Also Active</div>
                            ${items}
                        </div>
                    `;
      }

      // Top dynasty info
      let topInfo = "";
      if (data.top_dynasty) {
        topInfo = `Top: D${data.top_dynasty.dynasty_id} (${data.top_dynasty.dominance_percentage}%)`;
      }

      const chartId = `chart-${decade.replace(/[^a-zA-Z0-9]/g, "_")}`;

      card.innerHTML = `
                    <div class="decade-title">${decade}</div>
                    <div class="decade-subtitle">${data.period} | ${topInfo}</div>
                    <div class="chart-wrapper">
                        <div class="chart-container" id="${chartId}"></div>
                        <div class="legend-section">
                            <div class="legend-title">Dominant Dynasties</div>
                            ${dominantLegendHTML}
                            ${nonDominantLegendHTML}
                        </div>
                    </div>
                `;

      container.appendChild(card);

      // Initialize chart
      const chartDom = document.getElementById(chartId);
      const chart = echarts.init(chartDom);
      dec_charts[decade] = chart;

      // Prepare pie data
      const pieData = dominantDynasties.map((d) => ({
        value: d.dominance_percentage,
        name: `D${d.dynasty_id}`,
        itemStyle: {
          color: dec_dynastyColors[d.dynasty_id] || "#ccc",
        },
        dynasty_id: d.dynasty_id,
        years_dominant: d.years_dominant,
        total_years: data.total_years_analyzed,
        sector: d.primary_sector,
        market_cap: d.total_market_cap_bn,
        avg_dominance: d.avg_dominance_score,
        years_active: d.years_active_in_decade,
      }));

      const option = {
        tooltip: {
          trigger: "item",
          backgroundColor: "#FFFFFF",
          borderColor: "#E2E8F0",
          textStyle: { color: "#1B202B" },
          formatter: function (params) {
            const d = params.data;
            return `<div style="font-family:inherit;">
                                   <b>Dynasty ${d.dynasty_id}</b><br/>
                                   <span style="color:#008AFF">${
                                     d.sector
                                   }</span><br/>
                                   <b>Dominance:</b> ${d.value.toFixed(1)}%<br/>
                                   <b>Avg Score:</b> ${d.avg_dominance.toFixed(
                                     3
                                   )}
                                   </div>`;
          },
        },
        series: [
          {
            name: "Dominance",
            type: "pie",
            radius: ["35%", "70%"],
            center: ["50%", "50%"],
            avoidLabelOverlap: true,
            itemStyle: {
              borderRadius: 4,
              borderColor: "#FFFFFF",
              borderWidth: 2,
            },
            label: {
              show: true,
              position: "inside",
              formatter: function (params) {
                return `${params.percent.toFixed(0)}%`;
              },
              fontSize: 10,
              fontWeight: "bold",
              color: "#fff",
              textBorderColor: "transparent",
            },
            emphasis: {
              label: {
                show: true,
                fontSize: 12,
                fontWeight: "bold",
              },
              itemStyle: {
                shadowBlur: 10,
                shadowColor: "rgba(0, 0, 0, 0.1)",
              },
            },
            data: pieData,
          },
        ],
      };

      chart.setOption(option);
    });
  }

  // Initialize immediately
  if (dec_decadeData) {
    dec_createAllCharts();
  } else {
    // Retry once if loaded async
    setTimeout(() => {
      dec_decadeData = typeof decade_data !== "undefined" ? decade_data : null;
      dec_createAllCharts();
    }, 500);
  }

  // Handle resize with ResizeObserver for better responsiveness
  const dec_observer = new ResizeObserver(() => {
    Object.values(dec_charts).forEach((chart) => chart.resize());
  });

  const dec_wrapper = document.getElementById("decade-viz-wrapper");
  if (dec_wrapper) dec_observer.observe(dec_wrapper);
</script>
